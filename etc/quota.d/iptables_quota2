#!/bin/sh 

. /etc/vars

function append_iptables_quota_reject () {
    head="$1 $2 -j reject"
    iptables -C $head > /dev/null 2>&1
    if [ $? -eq "1" ]; then     
        iptables -A $head > /dev/null 2>&1
    fi
}

function append_iptables_quota_drop () {
    head="$1 $2 -j DROP"
    iptables -C $head > /dev/null 2>&1
    if [ $? -eq "1" ]; then     
        iptables -A $head > /dev/null 2>&1
    fi
}

function append_iptables_quota_limit () {
    head="$1 $2 -m limit --limit 11/s --limit-burst 22 -j ACCEPT"
    iptables -C $head > /dev/null 2>&1
    if [ $? -eq "1" ]; then     
        iptables -A $head > /dev/null 2>&1
    fi
}

# param chain, mode, idirection, sq
function append_iptables_quota () 
{ 
    case $2 in
        0)  
            head="$1 $extra_config $4 -m quota2 --name quota -j $3"
            iptables -C $head > /dev/null 2>&1
            if [ $? -eq 1 ]; then     
                iptables -A $head > /dev/null 2>&1
            fi
        ;;
        *)
            head="$1 $extra_config $4 -m quota2 --quota $quota_bytes --name quota -j $3"
            iptables -C $head > /dev/null 2>&1
            if [ $? -eq 1 ]; then     
                iptables -A $head > /dev/null 2>&1
            fi
        ;;
    esac
}

function append_iptables_quota_ex ()
{    
    for dire in $4; do
        local par;
        case $dire in
            "in")
                par = "-i $wan_device_name"
            ;;
            "out")
                par = "-o $wan_device_name"
            ;;
        esac
        append_iptables_quota "$1" "$2" "$nq_q_chain" "$par" 
    done     
}

if ([ -z $in_q_chain ] || [ -z $out_q_chain ] || [ -z $fwd_q_chain ]); then
    exit 1
fi 

case $1 in 
    "resetcounter")    
        echo 0 > $bytescounter
        export bytes_counter=$bytescounter
    ;;
esac

case $mode in 
    limit)        
    ;;
    reject)        
    ;;
    *)
        mode="drop"
    ;;
esac

case $mode in 
    "limitdrop")
        append_iptables_quota_limit "$1" "$extra_config"                
        append_iptables_quota_drop "$1" "$extra_config"                
    ;;
    "limitreject")
        append_iptables_quota_limit "$1" "$extra_config"                
        append_iptables_quota_reject "$1" "$extra_config"             
    ;;
    "drop")
        append_iptables_quota_drop "$1" "$extra_config"
    ;;
    "reject")
        append_iptables_quota_reject "$1" "$extra_config"
    ;;
esac

append_iptables_quota_ex $in_q_chain 1 "in"
append_iptables_quota_ex $out_q_chain 0 "out"
append_iptables_quota_ex $fwd_q_chain 0 "in out"

if [ ! -z $bytes_counter ]; then
    cat $bytes_counter > /proc/net/xt_quota/quota
fi
